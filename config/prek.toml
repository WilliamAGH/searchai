# prek.toml — Git hook configuration (replaces .husky/)
# Docs: https://prek.j178.dev/configuration/
#
# Priority controls execution order within a stage:
#   - Lower numbers run first
#   - Same priority = parallel execution (prek feature)
#   - Different priority = sequential

default_install_hook_types = ["pre-commit", "pre-push"]

[[repos]]
repo = "local"
hooks = [
  # ── Pre-commit hooks ──────────────────────────────────────────────
  # p10: typecheck + build in parallel (independent, both fast-fail)
  { id = "typecheck", name = "TypeScript type check", language = "system", entry = "npm run typecheck", always_run = true, pass_filenames = false, stages = [
    "pre-commit",
  ], priority = 10 },
  { id = "build", name = "Vite build validation", language = "system", entry = "npm run build", always_run = true, pass_filenames = false, stages = [
    "pre-commit",
  ], priority = 10 },
  # p20: Convex deployment validation (depends on types being clean)
  # --codegen=disable: prevents regenerating convex/_generated/ which conflicts
  #   with stashed WIP changes when prek restores the stash after the hook
  # --tail-logs=disable: prevents WebSocket log connection that keeps the
  #   Node.js event loop alive after push completes (the CLI's signal-exit
  #   handlers intercept SIGTERM, so the orphan WebSocket blocks clean exit)
  # timeout -k 10 60: sends SIGTERM at 60s, then SIGKILL at 70s as fallback
  #   (signal-exit in the Convex CLI bundle can delay SIGTERM cleanup)
  { id = "convex-validate", name = "Convex deployment validation", language = "system", entry = "timeout -k 10 60 npx convex dev --once --typecheck=enable --codegen=disable --tail-logs=disable", always_run = true, pass_filenames = false, verbose = true, stages = [
    "pre-commit",
  ], priority = 20 },
  # p30: lint-staged (lint staged files)
  { id = "lint-staged", name = "Lint staged files", language = "system", entry = "npx lint-staged", always_run = true, pass_filenames = false, stages = [
    "pre-commit",
  ], priority = 30 },
  # p40: tests (run after lint to avoid wasting time on unformatted code)
  { id = "test", name = "Run tests", language = "system", entry = "npm test", always_run = true, pass_filenames = false, stages = [
    "pre-commit",
  ], priority = 40 },

  # ── Pre-push hooks ────────────────────────────────────────────────
  # verbose = true on all pre-push hooks so output streams in real time
  # (prek suppresses output by default until failure, which hides hangs)
  #
  # p0: npm run validate — covers lint, typecheck, format:check, lint:loc,
  #     lint:convex-imports, lint:convex-types, lint:duplicates,
  #     lint:boundaries, tests, and build in one command
  { id = "validate", name = "Full validate suite", language = "system", entry = "npm run validate", always_run = true, pass_filenames = false, verbose = true, stages = [
    "pre-push",
  ], priority = 0, fail_fast = true },
  # p10: Convex deployment dry-run (not in validate)
  # --codegen=disable: prevents regenerating convex/_generated/ which conflicts
  #   with stashed WIP changes when prek restores the stash after the hook
  # --tail-logs=disable: prevents WebSocket log connection that keeps the
  #   Node.js event loop alive after push completes (the CLI's signal-exit
  #   handlers intercept SIGTERM, so the orphan WebSocket blocks clean exit)
  # timeout -k 10 60: sends SIGTERM at 60s, then SIGKILL at 70s as fallback
  #   (signal-exit in the Convex CLI bundle can delay SIGTERM cleanup)
  { id = "convex-push", name = "Convex deployment dry-run", language = "system", entry = "timeout -k 10 60 npx convex dev --once --typecheck=enable --codegen=disable --tail-logs=disable", always_run = true, pass_filenames = false, verbose = true, stages = [
    "pre-push",
  ], priority = 10 },
  # p20: Playwright smoke test (not in validate)
  { id = "smoke-test", name = "Playwright smoke test", language = "system", entry = "npx playwright test --config config/playwright.config.ts -g smoke --reporter=line", always_run = true, pass_filenames = false, verbose = true, stages = [
    "pre-push",
  ], priority = 20 },
]
