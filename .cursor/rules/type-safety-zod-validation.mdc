---
description: "Type safety and Zod validation standards"
globs: "**/*.ts,**/*.tsx"
---

# Type Safety & Zod Validation

Core rules in `CLAUDE.md`: [TY1], [VL1]

## [TS1] Strict Type Safety

- [TS1a] `noImplicitAny` enabled. Explicit `any` **FORBIDDEN** except Convex recursion limits.
- [TS1b] `unknown` only at boundaries; validate immediately, never propagate.
- [TS1c] Convex "excessively deep" errors: use `@ts-ignore` with comment, not global disables.

## [ZD1] Zod Version

- [ZD1a] Import `zod/v4` everywhere.
- [ZD1b] Exception: `convex/agents/tools.ts` uses `zod` v3 for OpenAI Agents SDK tool params.
- [ZD1c] v3 schemas must not cross integration boundary.

## [ZD2] Schema Location â€” Per [VL1]

- [ZD2a] **Canonical Zod schemas**: `convex/lib/schemas/` (importable by both `src/` and `convex/`)
- [ZD2b] **Convex validators**: `convex/lib/validators.ts` (required for database, cannot use Zod)
- [ZD2c] **No duplication**: Import from canonical location. Never redefine same schema.

## [ZD3] When to Validate

| Data Source | Validation | Why |
|-------------|------------|-----|
| External API (SerpAPI, scrapers) | Zod `.safeParse()` | Untrusted |
| Convex query/mutation result | **None** | Already validated by Convex |
| Tool call output (OpenAI SDK) | Zod `.safeParse()` | JSON parsing boundary |
| User form input | Zod or form library | Untrusted |

## [ZD4] Best Practices

- Use `.safeParse()` on untrusted data (never `.parse()` on network payloads).
- Derive types via `z.infer<typeof Schema>`.
- Use `.strict()` for stable API contracts.
