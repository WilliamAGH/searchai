---
description: "Type safety and Zod validation standards"
globs: "**/*.ts,**/*.tsx"
---

# Type Safety & Zod Validation

Core rules in `AGENTS.md`: [TY1], [VL1], [ZV1]

## [TS1] Strict Type Safety

- [TS1a] `noImplicitAny` enabled. Explicit `any` **FORBIDDEN** except Convex recursion limits.
- [TS1b] `unknown` only at boundaries; validate immediately, never propagate.
- [TS1c] Convex "excessively deep" errors: use `@ts-ignore` with comment, not global disables.

## [ZD1] Zod Version

- [ZD1a] Import `zod/v4` everywhere.
- [ZD1b] Exception: `convex/agents/tools.ts` uses `zod` v3 for OpenAI Agents SDK tool params.
- [ZD1c] v3 schemas must not cross integration boundary.

## [ZD2] Schema Location — Per [VL1]

- [ZD2a] **Canonical Zod schemas**: `convex/lib/schemas/` (importable by both `src/` and `convex/`)
- [ZD2b] **Convex validators**: `convex/lib/validators.ts` (required for database, cannot use Zod)
- [ZD2c] **No duplication**: Import from canonical location. Never redefine same schema.
- [ZD2d] **Validation utilities**: `convex/lib/validation/zodUtils.ts` — canonical location for `logZodFailure`, `safeParseWithLog`, `safeParseOrNull`, `parseArrayWithLogging`, `ValidationResult<T>`, and `isRecord`.

## [ZD3] When to Validate

| Data Source | Validation | Why |
|-------------|------------|-----|
| External API (SerpAPI, scrapers) | Zod `.safeParse()` | Untrusted |
| Convex query/mutation result | **None** | Already validated by Convex |
| Tool call output (OpenAI SDK) | Zod `.safeParse()` | JSON parsing boundary |
| User form input | Zod or form library | Untrusted |

## [ZD4] Best Practices

- Use `.safeParse()` on untrusted data (never `.parse()` on network payloads).
- Derive types via `z.infer<typeof Schema>`.
- Use `.strict()` for stable API contracts.

## [ZD5] Error Handling — Per [ZV1]

- [ZD5a] **Never swallow errors**: Use `logZodFailure(context, error, payload)` for all validation failures.
- [ZD5b] **Include record identifiers**: Context must identify WHICH record failed (e.g., `"parseUser [id=abc123]"`).
- [ZD5c] **Discriminated unions**: Return `{ success: true, data }` or `{ success: false, error }`, not `null`.
- [ZD5d] **Use canonical utilities**:

```typescript
import { logZodFailure, safeParseWithLog, safeParseOrNull } from "convex/lib/validation/zodUtils";

// Best: Discriminated union (new code)
const result = safeParseWithLog(UserSchema, data, `parseUser [id=${id}]`);
if (result.success) {
  // result.data is typed
} else {
  // result.error is ZodError (already logged)
}

// Legacy compatibility: Returns null (logs on failure)
const user = safeParseOrNull(UserSchema, data, `parseUser [id=${id}]`);
```

## [ZD6] Forbidden Patterns

```typescript
// FORBIDDEN: parse() throws and crashes rendering
const data = schema.parse(raw);

// FORBIDDEN: silent fallback swallows errors
const data = schema.safeParse(raw).data ?? defaultValue;

// FORBIDDEN: empty catch hides failures
try { schema.parse(raw); } catch { return null; }

// FORBIDDEN: no record identifier - can't debug
logZodFailure("parseResponse", error, raw);  // Which record??
```
