---
description: Chat domain architecture and refactoring plan, consolidated into a single rule file
alwaysApply: true
---

# Chat Domain

This rule consolidates the Chat Architecture overview and the Refactoring Plan into one canonical source.

## Architecture Overview

- Unified interface for real-time AI-powered search and conversation across authenticated (Convex) and unauthenticated (local) modes.
- Layers: Presentation (ChatInterface), Hooks (useUnifiedChat & split hooks), Repository (Local/Convex), Backend (Convex chats/messages/search/ai), Streaming SSE, and Share system.
- Key features: hybrid storage with migration, streaming, multi-provider search, share IDs, rolling summaries, topic detection.

## Data Structures (Summary)

- UnifiedChat / UnifiedMessage (client types) for UI cohesion.
- Convex schema: `chats` with `title`, `userId`, `privacy`, `shareId`, `publicId`, timestamps, summary fields.

## Design Decisions

- Repository pattern enables seamless transition between local and Convex storage.
- SSE-based streaming improves UX; requires careful error handling.
- Search fallback chain trades latency for result guarantees.

## Refactoring Plan (Phased)

1. Type Consolidation (Critical)
   - Single source for Chat and Message types; remove duplicates across components.
2. Validation Layer (High)
   - Runtime validation for untrusted inputs; align with Convex v validators.
3. Performance Optimizations (Medium)
   - Pagination, memoization, virtualization.
4. Hydration & Environment (High)
   - Ensure consistent state across SSR/CSR (where applicable) and strict env validation.
5. Bugs & Improvements (Medium)
   - Systematically address logged issues in bug fix documents.

## Operations & Testing

- Use `npm run validate`, coverage thresholds, and e2e smoke suites.
- Health checks via /health endpoint.

## Security

- rehype-sanitize for HTML content.
- Strict URL and length checks in HTTP routes.

