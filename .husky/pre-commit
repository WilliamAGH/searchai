#!/usr/bin/env sh
# Husky v9: plain POSIX shell, no husky.sh sourcing
# Exit on unset and any error
set -eu

echo "ğŸ” Running comprehensive pre-commit checks..."

# 1. TypeScript type checking (catch type errors)
echo "ğŸ“ TypeScript type check..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors detected!"
  exit 1
fi

# 2. Quick Vite build check (catches import/syntax errors early!)
echo "ğŸ—ï¸ Quick build validation..."
npm run build --silent > /tmp/build-check.log 2>&1
BUILD_EXIT_CODE=$?
if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "âŒ Build failed! This would break deployment."
  echo "ğŸ“‹ Build errors:"
  tail -20 /tmp/build-check.log
  exit 1
fi

# 3. Convex deployment validation (catch deployment issues!)
echo "ğŸš€ Validating Convex deployment..."
# Use documented --typecheck=enable flag for strict checking
npx --no-install convex dev --once --typecheck=enable > /tmp/convex-check.log 2>&1
CONVEX_EXIT_CODE=$?
if [ $CONVEX_EXIT_CODE -ne 0 ]; then
  echo "âŒ Convex deployment validation failed!"
  echo "ğŸ’¡ Common issues to check:"
  echo "   âœ— Type mismatches in function signatures"
  echo "   âœ— Import errors or missing dependencies"
  echo "   âœ— HTTP route shape or auth config issues"
  echo ""
  echo "ğŸ“‹ Error details:"
  grep -E "(error|Error|failed)" /tmp/convex-check.log | head -20 || tail -n +1 /tmp/convex-check.log | head -50
  exit 1
fi

# Warn (do not fail) on process.env mentions to avoid false positives
if grep -E "process\\.env" /tmp/convex-check.log > /dev/null; then
  echo "âš ï¸  Note: Found references to process.env in Convex code/logs."
  echo "   Convex runtime prefers ctx.env.get('KEY') for server-side envs."
  echo "   Matches:"
  grep -nE "process\\.env" /tmp/convex-check.log | head -5
fi

# 4. Lint staged files (auto-fix issues)
echo "ğŸ§¹ Linting staged files..."
npx --no-install lint-staged

# 5. Quick test run (ensure tests pass)
echo "ğŸ§ª Running tests..."
npm test --silent
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed! Fix tests before committing."
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
