#!/usr/bin/env sh
# Husky v9: plain POSIX shell, no husky.sh sourcing
# Exit on unset and any error
set -eu

# Source Husky init script if it exists (for PATH setup)
if [ -f "$HOME/.config/husky/init.sh" ]; then
  . "$HOME/.config/husky/init.sh"
fi

echo "ğŸ” Running comprehensive pre-commit checks..."

# 1. TypeScript type checking (catch type errors)
echo "ğŸ“ TypeScript type check..."
set +e
npm run typecheck > /tmp/tsc-precommit.log 2>&1
TSC_EXIT=$?
set -e
if [ $TSC_EXIT -ne 0 ]; then
  echo "âŒ TypeScript errors detected (pre-commit)."
  echo "ğŸ“„ Log: /tmp/tsc-precommit.log"
  echo "--- First errors (up to 40 lines) ---"
  # Show key TS error lines if present, else show head
  if grep -nE "error TS[0-9]+" /tmp/tsc-precommit.log >/dev/null; then
    grep -nE "error TS[0-9]+" /tmp/tsc-precommit.log | head -n 20
  else
    sed -n '1,40p' /tmp/tsc-precommit.log
  fi
  echo "-------------------------------------"
  echo "ğŸ’¡ Tip: run 'npm run typecheck' to reproduce."
  exit 1
fi

# 2. Quick Vite build check (catches import/syntax errors early!)
echo "ğŸ—ï¸ Quick build validation..."
set +e
npm run build --silent > /tmp/build-check.log 2>&1
BUILD_EXIT_CODE=$?
set -e
if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "âŒ Build failed! This would break deployment."
  echo "ğŸ“„ Log: /tmp/build-check.log"
  echo "--- Last 40 lines ---"
  tail -40 /tmp/build-check.log
  echo "-------------------------------------"
  # Try to surface vite error lines
  if grep -nE "(error|Error|Failed|failed)" /tmp/build-check.log >/dev/null; then
    echo "ğŸ” Notable errors:"
    grep -nE "(error|Error|Failed|failed)" /tmp/build-check.log | head -n 10
  fi
  echo "ğŸ’¡ Tip: run 'npm run build' locally to reproduce."
  exit 1
fi

# 3. Convex deployment validation (catch deployment issues!)
echo "ğŸš€ Validating Convex deployment..."
# Use documented --typecheck=enable flag for strict checking
set +e
npx --no-install convex dev --once --typecheck=enable > /tmp/convex-check.log 2>&1
CONVEX_EXIT_CODE=$?
set -e
if [ $CONVEX_EXIT_CODE -ne 0 ]; then
  echo "âŒ Convex deployment validation failed!"
  echo "ğŸ“„ Log: /tmp/convex-check.log"
  echo "ğŸ—‚ï¸  Changed files in convex/ (staged):"
  git diff --name-only --cached -- convex 2>/dev/null | sed -n '1,50p' || true
  echo "ğŸ—‚ï¸  Changed files in convex/ (unstaged):"
  git diff --name-only -- convex 2>/dev/null | sed -n '1,50p' || true
  echo "--- First 80 lines ---"
  sed -n '1,80p' /tmp/convex-check.log || true
  echo "--- Last 60 lines ---"
  tail -60 /tmp/convex-check.log
  echo "-------------------------------------"
  echo "ğŸ” Notable errors:"
  grep -nE "(TS[0-9]+|TypeError|ReferenceError|SyntaxError|error:|Error:|failed|Failure|Exception)" /tmp/convex-check.log | head -n 25 || true
  echo "ğŸ” File references:"
  grep -nE "convex/[A-Za-z0-9_./-]+\.ts[:)]" /tmp/convex-check.log | head -n 15 || true
  echo "ğŸ’¡ Tip: run 'npx convex dev --once --typecheck=enable' to reproduce."
  exit 1
fi

# Extra: dedicated Convex TS check to pinpoint errors fast
echo "ğŸ§¾ Convex TypeScript check..."
set +e
npx --no-install tsc -p convex --noEmit --pretty false > /tmp/tsc-convex.log 2>&1
CONVEX_TSC=$?
set -e
if [ $CONVEX_TSC -ne 0 ]; then
  echo "âŒ Convex TS errors detected."
  echo "ğŸ“„ Log: /tmp/tsc-convex.log"
  if grep -nE "error TS[0-9]+" /tmp/tsc-convex.log >/dev/null; then
    grep -nE "error TS[0-9]+" /tmp/tsc-convex.log | head -n 30
  else
    sed -n '1,60p' /tmp/tsc-convex.log
  fi
  echo "-------------------------------------"
  echo "ğŸ’¡ Tip: run 'npx tsc -p convex --noEmit' to reproduce."
  exit 1
fi

# Warn (do not fail) on process.env mentions to avoid false positives
set +e
grep -E "process\\.env" /tmp/convex-check.log > /dev/null
HAS_PROC_ENV=$?
set -e
if [ ${HAS_PROC_ENV:-1} -eq 0 ]; then
  echo "âš ï¸  Note: Found references to process.env in Convex code/logs."
  echo "   Convex runtime prefers ctx.env.get('KEY') for server-side envs."
  echo "   Matches:"
  grep -nE "process\\.env" /tmp/convex-check.log | head -5
fi

# 4. Lint staged files (auto-fix issues)
echo "ğŸ§¹ Linting staged files..."
npx --no-install lint-staged

# 5. Quick test run (ensure tests pass)
echo "ğŸ§ª Running tests..."
npm run test:precommit --silent > /tmp/node-tests-precommit.log 2>&1 || TEST_EXIT=$?
TEST_EXIT=${TEST_EXIT:-0}
if [ $TEST_EXIT -ne 0 ]; then
  echo "âŒ Tests failed! Fix tests before committing."
  echo "ğŸ“„ Log: /tmp/node-tests-precommit.log"
  echo "--- Test failures ---"
  # Try to extract specific test failures
  if grep -E "(FAIL|âœ—|âŒ|Error:|failed:|FAILED)" /tmp/node-tests-precommit.log >/dev/null; then
    grep -E "(FAIL|âœ—|âŒ|Error:|failed:|FAILED)" /tmp/node-tests-precommit.log | head -20
  else
    # Print last lines for quick context
    tail -40 /tmp/node-tests-precommit.log
  fi
  echo "ğŸ’¡ Tip: run 'npm run test:precommit' locally to reproduce."
  exit 1
fi

echo "âœ… All pre-commit checks passed!"
