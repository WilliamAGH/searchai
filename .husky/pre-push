#!/usr/bin/env sh
# Husky v9: plain POSIX shell, no husky.sh sourcing
# Exit on unset and any error
set -eu

echo "üöÄ Running comprehensive pre-push validation..."

# 1. Full production build (catches ALL issues!)
echo "üèóÔ∏è Full production build validation..."
npm run build > /tmp/full-build.log 2>&1
BUILD_EXIT_CODE=$?
if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "‚ùå Production build failed!"
  echo "üìã Build errors:"
  tail -30 /tmp/full-build.log
  echo ""
  echo "üí° Run 'npm run build' locally to debug"
  exit 1
fi

# 2. Full TypeScript check (including Convex)
echo "üìù Full TypeScript validation..."
npx --no-install tsc -p . --noEmit --pretty false
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript errors in main project!"
  exit 1
fi

npx --no-install tsc -p convex --noEmit --pretty false
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript errors in Convex functions!"
  exit 1
fi

# 2. Convex deployment dry-run (CRITICAL - catches deployment failures!)
echo "üîß Testing Convex deployment..."
# Use documented --typecheck=enable for strict validation
set +e
npx --no-install convex dev --once --typecheck=enable > /tmp/convex-deploy.log 2>&1
CONVEX_EXIT_CODE=$?
set -e
if [ $CONVEX_EXIT_CODE -ne 0 ]; then
  echo "‚ùå CRITICAL: Convex deployment would fail!"
  echo "üìÑ Log: /tmp/convex-deploy.log"
  echo "üóÇÔ∏è  Changed files in convex/ (staged):"
  git diff --name-only --cached -- convex 2>/dev/null | sed -n '1,50p' || true
  echo "üóÇÔ∏è  Changed files in convex/ (unstaged):"
  git diff --name-only -- convex 2>/dev/null | sed -n '1,50p' || true
  echo "--- First 80 lines ---"
  sed -n '1,80p' /tmp/convex-deploy.log || true
  echo "--- Last 60 lines ---"
  tail -60 /tmp/convex-deploy.log
  echo "-------------------------------------"
  echo "üîé Notable errors:"
  grep -nE "(TS[0-9]+|TypeError|ReferenceError|SyntaxError|error:|Error:|failed|Failure|Exception)" /tmp/convex-deploy.log | head -n 25 || true
  echo "üîé File references:"
  grep -nE "convex/[A-Za-z0-9_./-]+\.ts[:)]" /tmp/convex-deploy.log | head -n 15 || true
  echo "üí° Fix these issues before pushing. Reproduce: npx convex dev --once --typecheck=enable"
  exit 1
fi

# 3. Full test suite
echo "üß™ Running full test suite..."
npm test > /tmp/node-tests-prepush.log 2>&1 || TEST_EXIT=$?
TEST_EXIT=${TEST_EXIT:-0}
if [ $TEST_EXIT -ne 0 ]; then
  echo "‚ùå Tests failed!"
  echo "üìÑ Log: /tmp/node-tests-prepush.log"
  tail -40 /tmp/node-tests-prepush.log
  echo "üí° Tip: run 'npm test' locally to reproduce."
  exit 1
fi

# 4. Build validation
echo "üèóÔ∏è Validating production build..."
npm run build --silent > /tmp/build.log 2>&1
if [ $? -ne 0 ]; then
  echo "‚ùå Build failed!"
  echo "Check build errors:"
  tail -20 /tmp/build.log
  exit 1
fi

# 5. Playwright smoke test (fail on console errors)
echo "üïµÔ∏è Smoke test: ensuring no console errors..."
if npx --no-install playwright --version > /dev/null 2>&1; then
  # Run only the smoke test for speed. Playwright config starts a preview server.
  set +e
  npx --no-install playwright test -g smoke --reporter=line | tee /tmp/playwright-smoke.log
  PW_EXIT=${PIPESTATUS[0]}
  set -e
  if [ ${PW_EXIT:-0} -ne 0 ]; then
    echo "‚ùå Smoke test failed (console errors or network failures)."
    echo "üìÑ Log: /tmp/playwright-smoke.log"
    # Surface the key error lines
    grep -nE "(ReferenceError|TypeError|Error: |pageerror|requestfailed)" /tmp/playwright-smoke.log | head -n 10 || true
    # Show available artifacts
    TRACE_ZIP=$(find test-results -name trace.zip -type f -print -quit 2>/dev/null || true)
    SCREENSHOT=$(find test-results -name 'test-failed-*.png' -type f -print -quit 2>/dev/null || true)
    if [ -n "$TRACE_ZIP" ]; then
      echo "üß≠ Trace: $TRACE_ZIP"
      echo "   Open with: npx playwright show-trace \"$TRACE_ZIP\""
    fi
    if [ -n "$SCREENSHOT" ]; then
      echo "üñºÔ∏è  Screenshot: $SCREENSHOT"
    fi
    echo "üí° Reproduce: npx playwright test -g smoke --reporter=line"
    exit 1
  fi
else
  echo "‚ÑπÔ∏è  Playwright not installed. Skipping smoke test."
  echo "   Install with: npm i -D @playwright/test && npx playwright install"
fi

# 6. Check for common issues
echo "üîç Checking for common issues..."

# Check for console.logs in production code
if grep -r "console\.log" --include="*.ts" --include="*.tsx" convex/ src/ | grep -v "^//" | grep -v "tests/" > /dev/null; then
  echo "‚ö†Ô∏è  Warning: console.log statements found in production code"
  echo "Consider removing these before deployment:"
  grep -r "console\.log" --include="*.ts" --include="*.tsx" convex/ src/ | grep -v "^//" | grep -v "tests/" | head -5
fi

# Check for TODO comments
TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX" --include="*.ts" --include="*.tsx" convex/ src/ | wc -l)
if [ $TODO_COUNT -gt 0 ]; then
  echo "üìù Note: $TODO_COUNT TODO/FIXME comments found"
fi

echo "‚úÖ All pre-push checks passed! Safe to push."
