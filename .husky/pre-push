#!/usr/bin/env sh
# Husky v9: plain POSIX shell, no husky.sh sourcing
# Exit on unset and any error
set -eu

echo "üöÄ Running comprehensive pre-push validation..."

# 1. Full production build (catches ALL issues!)
echo "üèóÔ∏è Full production build validation..."
FULL_BUILD_LOG="$(mktemp -t full-build.XXXXXX.log)"
if ! npm run build > "$FULL_BUILD_LOG" 2>&1; then
  echo "‚ùå Production build failed!"
  echo "üìã Build errors:"
  tail -30 "$FULL_BUILD_LOG"
  echo ""
  echo "üí° Run 'npm run build' locally to debug"
  exit 1
fi

# 2. Full TypeScript check (including Convex)
echo "üìù Full TypeScript validation..."
MAIN_TSC_LOG="$(mktemp -t tsc-main.XXXXXX.log)"
if ! npx --no-install tsc -p . --noEmit --pretty false > "$MAIN_TSC_LOG" 2>&1; then
  echo "‚ùå TypeScript errors in main project!"
  echo "üìÑ Log: $MAIN_TSC_LOG"
  grep -nE "error TS[0-9]+" "$MAIN_TSC_LOG" | head -n 20 || sed -n '1,60p' "$MAIN_TSC_LOG"
  exit 1
fi

CONVEX_TSC_LOG="$(mktemp -t tsc-convex.XXXXXX.log)"
if ! npx --no-install tsc -p convex --noEmit --pretty false > "$CONVEX_TSC_LOG" 2>&1; then
  echo "‚ùå TypeScript errors in Convex functions!"
  echo "üìÑ Log: $CONVEX_TSC_LOG"
  grep -nE "error TS[0-9]+" "$CONVEX_TSC_LOG" | head -n 20 || sed -n '1,60p' "$CONVEX_TSC_LOG"
  exit 1
fi

# 2. Convex deployment dry-run (CRITICAL - catches deployment failures!)
echo "üîß Testing Convex deployment..."
CONVEX_LOG="$(mktemp -t convex-deploy.XXXXXX.log)"
# Use documented --typecheck=enable for strict validation
if ! npx --no-install convex dev --once --typecheck=enable > "$CONVEX_LOG" 2>&1; then
  echo "‚ùå CRITICAL: Convex deployment would fail!"
  echo "üìÑ Log: $CONVEX_LOG"
  echo "üóÇÔ∏è  Changed files in convex/ (staged):"
  git diff --name-only --cached -- convex 2>/dev/null | sed -n '1,50p' || true
  echo "üóÇÔ∏è  Changed files in convex/ (unstaged):"
  git diff --name-only -- convex 2>/dev/null | sed -n '1,50p' || true
  echo "--- First 80 lines ---"
  sed -n '1,80p' "$CONVEX_LOG" || true
  echo "--- Last 60 lines ---"
  tail -60 "$CONVEX_LOG"
  echo "-------------------------------------"
  echo "üîé Notable errors:"
  grep -niE "(TS[0-9]+|TypeError|ReferenceError|SyntaxError|error|failed|fatal|Failure|Exception)" "$CONVEX_LOG" | head -n 25 || true
  echo "üîé File references:"
  grep -nE "convex/[A-Za-z0-9_./-]+\.ts[:)]" "$CONVEX_LOG" | head -n 15 || true
  echo "üí° Fix these issues before pushing. Reproduce: npx convex dev --once --typecheck=enable"
  exit 1
fi

# 3. Full test suite
echo "üß™ Running full test suite..."
npm test > /tmp/node-tests-prepush.log 2>&1 || TEST_EXIT=$?
TEST_EXIT=${TEST_EXIT:-0}
if [ $TEST_EXIT -ne 0 ]; then
  echo "‚ùå Tests failed!"
  echo "üìÑ Log: /tmp/node-tests-prepush.log"
  tail -40 /tmp/node-tests-prepush.log
  echo "üí° Tip: run 'npm test' locally to reproduce."
  exit 1
fi

# Removed duplicate build; Step 1 already validates production build.

# 5. Playwright smoke test (fail on console errors)
echo "üïµÔ∏è Smoke test: ensuring no console errors..."
if npx --no-install playwright --version > /dev/null 2>&1; then
  # Run only the smoke test for speed. Playwright config starts a preview server.
  PW_LOG="$(mktemp -t playwright-smoke.XXXXXX.log)"
  if ! npx --no-install playwright test -g smoke --reporter=line > "$PW_LOG" 2>&1; then
    echo "‚ùå Smoke test failed (console errors or network failures)."
    echo "üìÑ Log: $PW_LOG"
    # Surface the key error lines
    grep -nE "(ReferenceError|TypeError|Error: |pageerror|requestfailed)" "$PW_LOG" | head -n 10 || true
    # Show available artifacts
    TRACE_ZIP=$(find test-results -name trace.zip -type f -print -quit 2>/dev/null || true)
    SCREENSHOT=$(find test-results -name 'test-failed-*.png' -type f -print -quit 2>/dev/null || true)
    if [ -n "$TRACE_ZIP" ]; then
      echo "üß≠ Trace: $TRACE_ZIP"
      echo "   Open with: npx playwright show-trace \"$TRACE_ZIP\""
    fi
    if [ -n "$SCREENSHOT" ]; then
      echo "üñºÔ∏è  Screenshot: $SCREENSHOT"
    fi
    echo "üí° Reproduce: npx playwright test -g smoke --reporter=line"
    exit 1
  fi
else
  echo "‚ÑπÔ∏è  Playwright not installed. Skipping smoke test."
  echo "   Install with: npm i -D @playwright/test && npx playwright install"
fi

# 6. Check for common issues
echo "üîç Checking for common issues..."

# Check for console.logs in production code (ignore comments/tests/generated)
if grep -R -nE '^\s*console\.log\(' --include="*.ts" --include="*.tsx" convex/ src/ \
  | grep -vE '/(__tests__|tests|__mocks__|stories|_generated)/' > /dev/null; then
  echo "‚ö†Ô∏è  Warning: console.log statements found in production code"
  echo "Consider removing these before deployment:"
  grep -R -nE '^\s*console\.log\(' --include="*.ts" --include="*.tsx" convex/ src/ \
    | grep -vE '/(__tests__|tests|__mocks__|stories|_generated)/' | head -5
fi

# Check for TODO comments
TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX" --include="*.ts" --include="*.tsx" convex/ src/ | wc -l)
if [ $TODO_COUNT -gt 0 ]; then
  echo "üìù Note: $TODO_COUNT TODO/FIXME comments found"
fi

echo "‚úÖ All pre-push checks passed! Safe to push."
