#!/usr/bin/env sh
# Husky v9: plain POSIX shell, no husky.sh sourcing
# Exit on unset and any error
set -eu

# Ensure local binaries and consistent Node in non-login shells (e.g., VS Code)
export PATH="$PWD/node_modules/.bin:$PATH"

# Try to load Node via NVM/FNM/Volta if not already available
if ! command -v node >/dev/null 2>&1; then
  if [ -s "$HOME/.nvm/nvm.sh" ]; then
    . "$HOME/.nvm/nvm.sh"
    nvm use >/dev/null 2>&1 || true
  fi
  if command -v fnm >/dev/null 2>&1; then
    eval "$(fnm env --shell=sh)"
    fnm use >/dev/null 2>&1 || true
  fi
  if [ -d "$HOME/.volta/bin" ]; then
    export PATH="$HOME/.volta/bin:$PATH"
  fi
fi

# Note: Do NOT export CONVEX_DEPLOYMENT globally; it interferes with tests

# Source Husky init script if it exists (for PATH setup)
if [ -f "$HOME/.config/husky/init.sh" ]; then
  . "$HOME/.config/husky/init.sh"
fi

echo "üöÄ Running comprehensive pre-push validation..."

# 1. Full production build (catches ALL issues!)
echo "üèóÔ∏è Full production build validation..."
FULL_BUILD_LOG="$(mktemp -t full-build.XXXXXX.log)"
if ! npm run build > "$FULL_BUILD_LOG" 2>&1; then
  echo "‚ùå Production build failed!"
  echo "üìÑ Full log: $FULL_BUILD_LOG"
  echo ""
  echo "üìã Build errors:"
  echo "----------------------------------------"
  # Show specific errors first
  grep -E "(error|Error:|failed|Failed|ERROR)" "$FULL_BUILD_LOG" | head -20 || true
  echo ""
  # Then show last 30 lines for context
  echo "Last 30 lines of output:"
  tail -30 "$FULL_BUILD_LOG"
  echo "----------------------------------------"
  echo ""
  echo "üí° Run 'npm run build' locally to debug"
  exit 1
fi

# 2. Full TypeScript check (including Convex)
echo "üìù Full TypeScript validation..."
MAIN_TSC_LOG="$(mktemp -t tsc-main.XXXXXX.log)"
if ! npx --no-install tsc -p . --noEmit --pretty false > "$MAIN_TSC_LOG" 2>&1; then
  echo "‚ùå TypeScript errors in main project!"
  echo "üìÑ Full log: $MAIN_TSC_LOG"
  echo ""
  echo "üìã TypeScript errors:"
  echo "----------------------------------------"
  # Extract and format TS errors
  grep -E "error TS[0-9]+" "$MAIN_TSC_LOG" | head -20
  echo "----------------------------------------"
  echo ""
  echo "üí° Run 'npx tsc -p . --noEmit' to see all errors"
  exit 1
fi

CONVEX_TSC_LOG="$(mktemp -t tsc-convex.XXXXXX.log)"
if ! npx --no-install tsc -p convex --noEmit --pretty false > "$CONVEX_TSC_LOG" 2>&1; then
  echo "‚ùå TypeScript errors in Convex functions!"
  echo "üìÑ Full log: $CONVEX_TSC_LOG"
  echo ""
  echo "üìã TypeScript errors:"
  echo "----------------------------------------"
  # Extract and format TS errors
  grep -E "error TS[0-9]+" "$CONVEX_TSC_LOG" | head -20
  echo "----------------------------------------"
  echo ""
  echo "üí° Run 'npx tsc -p convex --noEmit' to see all errors"
  exit 1
fi

# 3. Convex deployment dry-run (CRITICAL - catches deployment failures!)
echo "üîß Testing Convex deployment..."
CONVEX_LOG="$(mktemp -t convex-deploy.XXXXXX.log)"
# Use documented --typecheck=enable for strict validation
# Scope CONVEX_DEPLOYMENT only to this command to avoid leaking into tests
if ! CONVEX_DEPLOYMENT="${CONVEX_DEPLOYMENT:-diligent-greyhound-240}" \
  npx --no-install convex dev --once --typecheck=enable > "$CONVEX_LOG" 2>&1; then
  echo "‚ùå CRITICAL: Convex deployment would fail!"
  echo "üìÑ Log: $CONVEX_LOG"
  echo "üóÇÔ∏è  Changed files in convex/ (staged):"
  git diff --name-only --cached -- convex 2>/dev/null | sed -n '1,50p' || true
  echo "üóÇÔ∏è  Changed files in convex/ (unstaged):"
  git diff --name-only -- convex 2>/dev/null | sed -n '1,50p' || true
  echo "--- First 80 lines ---"
  sed -n '1,80p' "$CONVEX_LOG" || true
  echo "--- Last 60 lines ---"
  tail -60 "$CONVEX_LOG"
  echo "-------------------------------------"
  echo "üîé Notable errors:"
  grep -niE "(TS[0-9]+|TypeError|ReferenceError|SyntaxError|error|failed|fatal|Failure|Exception)" "$CONVEX_LOG" | head -n 25 || true
  echo "üîé File references:"
  grep -nE "convex/[A-Za-z0-9_./-]+\.ts[:)]" "$CONVEX_LOG" | head -n 15 || true
  echo "üí° Fix these issues before pushing. Reproduce: npx convex dev --once --typecheck=enable"
  exit 1
fi

# 4. Fast unit tests only (Vitest - catches most issues quickly)
echo "üß™ Running unit tests (Vitest)..."
VITEST_LOG="$(mktemp -t vitest.XXXXXX.log)"
if ! npm run test:vitest:prepush > "$VITEST_LOG" 2>&1; then
  echo "‚ùå Unit tests failed!"
  echo "üìÑ Full log: $VITEST_LOG"
  echo ""
  echo "üìã Test failures:"
  echo "----------------------------------------"
  # Show the last 60 lines which should include the failure summary
  tail -60 "$VITEST_LOG"
  echo "----------------------------------------"
  echo ""
  # Try to extract specific test failures
  echo "üîé Failed tests:"
  grep -E "(FAIL|‚úó|‚ùå|Error:|failed:|FAILED)" "$VITEST_LOG" | head -20 || true
  echo ""
  echo "üí° Reproduce locally: npm run test:vitest:prepush"
  exit 1
fi

# 5. Quick Playwright smoke test (with proxy runtime for reliability)
echo "üé≠ Running Playwright smoke test..."
PLAYWRIGHT_LOG="$(mktemp -t playwright.XXXXXX.log)"
# Use proxy runtime as per project requirements for 100% pass rate
if ! PLAYWRIGHT_RUNTIME=proxy npm run test:playwright:headless > "$PLAYWRIGHT_LOG" 2>&1; then
  echo "‚ùå Playwright smoke test failed!"
  echo "üìÑ Full log: $PLAYWRIGHT_LOG"
  echo ""
  echo "üìã Test failures:"
  echo "----------------------------------------"
  # Show the last 60 lines which should include the failure summary
  tail -60 "$PLAYWRIGHT_LOG"
  echo "----------------------------------------"
  echo ""
  # Try to extract specific test failures
  echo "üîé Failed tests:"
  grep -E "(FAIL|‚úó|‚ùå|Error:|failed:|FAILED)" "$PLAYWRIGHT_LOG" | head -20 || true
  echo ""
  echo "üí° Reproduce locally: PLAYWRIGHT_RUNTIME=proxy npm run test:playwright:headless"
  exit 1
fi

# 6. Check environment variable usage patterns
echo "üîç Checking environment variable usage patterns..."
ENV_CHECK_LOG="$(mktemp -t env-check.XXXXXX.log)"
if ! npm run check:env-vars > "$ENV_CHECK_LOG" 2>&1; then
  echo "‚ùå Environment variable usage validation failed!"
  echo "üìÑ Full log: $ENV_CHECK_LOG"
  echo ""
  cat "$ENV_CHECK_LOG"
  echo ""
  echo "üí° Fix these issues before pushing"
  exit 1
fi

# 7. Check for common issues
echo "üîç Checking for common issues..."

# Check for console.logs in production code (ignore comments/tests/generated)
if grep -R -nE '^\s*console\.log\(' --include="*.ts" --include="*.tsx" convex/ src/ \
  | grep -vE '/(__tests__|tests|__mocks__|stories|_generated)/' > /dev/null; then
  echo "‚ö†Ô∏è  Warning: console.log statements found in production code"
  echo "Consider removing these before deployment:"
  grep -R -nE '^\s*console\.log\(' --include="*.ts" --include="*.tsx" convex/ src/ \
    | grep -vE '/(__tests__|tests|__mocks__|stories|_generated)/' | head -5
fi

# Check for TODO comments
TODO_COUNT=$(grep -R -nE "(TODO|FIXME|XXX)" --include="*.ts" --include="*.tsx" convex/ src/ | wc -l)
if [ $TODO_COUNT -gt 0 ]; then
  echo "üìù Note: $TODO_COUNT TODO/FIXME comments found"
fi

echo "‚úÖ All pre-push checks passed! Safe to push."

# Clean up temp files
rm -f "$FULL_BUILD_LOG" "$MAIN_TSC_LOG" "$CONVEX_TSC_LOG" "$CONVEX_LOG" "$VITEST_LOG" "$PLAYWRIGHT_LOG" "$ENV_CHECK_LOG"
